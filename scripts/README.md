# E2E Тесты для бота "Наследие"

Этот скрипт тестирует все основные сценарии работы бота.

## Подготовка к тестированию

1. **Скопируйте файл с переменными окружения:**
   ```bash
   cp scripts/test.env .env.test
   ```

2. **Заполните переменные в `.env.test`:**
   - `BOT_TOKEN` - токен вашего бота
   - `ADMIN_CHAT_ID` - ID админ-чата (отрицательное число для групп)
   - `TEST_USER_TG_ID` - ID тестового пользователя
   - `API_URL` - URL API (обычно `http://localhost:8000`)
   - `APP_SECRET` - секретный ключ API

3. **Запустите бота и API:**
   ```bash
   docker-compose up -d
   ```

## Запуск тестов

### Все тесты
```bash
source .env.test && ./scripts/e2e.sh
```

### Очистка тестовых данных
```bash
./scripts/e2e.sh cleanup
```

### Справка
```bash
./scripts/e2e.sh help
```

## Что тестируется

### 1. Регистрация пользователя
- Команда `/start`
- Команда `/reg`
- Ввод номера телефона
- Проверка успешной регистрации

### 2. Отправка статей
- Отправка ссылок на статьи
- Обработка различных форматов URL
- Проверка отправки в админ-чат

### 3. Отправка фото
- Отправка фотографий мероприятий
- Проверка обработки файлов

### 4. Админ-модерация
- Команда `/leaderboard`
- Команда `/broadcast`
- Модерация заявок (принятие/отклонение)
- Отправка причин отклонения

### 5. API endpoints
- Health check
- Leaderboard API
- Pending submissions API
- Users API

### 6. База данных
- Подключение к БД
- Чтение данных пользователей
- Проверка целостности данных

### 7. Обработка ошибок
- Невалидные ссылки
- Несуществующие пользователи
- Некорректные команды

### 8. Производительность
- Отправка множественных сообщений
- Время отклика API
- Нагрузочное тестирование

### 9. Безопасность
- Проверка авторизации API
- Валидация секретного ключа
- Защита от неавторизованных запросов

### 10. Логирование
- Логи бота
- Логи API
- Отслеживание ошибок

## Интерпретация результатов

- ✅ **Успех** - тест прошел успешно
- ❌ **Ошибка** - тест не прошел, требуется исправление
- ⚠️ **Предупреждение** - тест прошел, но есть замечания

## Устранение проблем

### API недоступен
- Проверьте, что контейнеры запущены: `docker-compose ps`
- Проверьте логи API: `docker-compose logs app`

### Бот не отвечает
- Проверьте токен бота
- Проверьте логи бота: `docker-compose logs bot`

### Ошибки базы данных
- Проверьте подключение к БД: `docker-compose logs db`
- Проверьте миграции: `docker-compose exec app alembic current`

### Проблемы с модерацией
- Убедитесь, что `ADMIN_CHAT_ID` указан правильно
- Проверьте, что бот добавлен в админ-чат

## Автоматизация

Для автоматического запуска тестов можно использовать cron:

```bash
# Запуск тестов каждый час
0 * * * * cd /path/to/nasledie_bot && source .env.test && ./scripts/e2e.sh
```

Или GitHub Actions для CI/CD.
